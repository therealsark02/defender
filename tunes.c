/*
 * SPDX-License-Identifier: BSD-2-Clause
 *
 * Copyright (c) 2025 sark02
 */

/*
 * High score table tunes.
 * The tunes are far too long to keep as samples, so instead they're
 * played using a simple YM2149 function.
 */

#include "gd.h"
#include "ym2149.h"
#include "tunes.h"

typedef struct note_s {
    uint8_t afine;
    uint8_t acoarse;
    uint8_t bfine;
    uint8_t bcoarse;
    uint8_t cfine;
    uint8_t ccoarse;
    uint8_t duration;
} note_t;

typedef struct {
    const note_t *notes;
    uint16_t len;
} tune_t;

static const note_t taccata_notes[] = {
    { 0xb1, 0x04, 0x58, 0x02, 0x2c, 0x01, 0x04 },
    { 0x47, 0x05, 0xa3, 0x02, 0x51, 0x01, 0x04 },
    { 0xb1, 0x04, 0x58, 0x02, 0x2c, 0x01, 0x57 },
    { 0x4c, 0x06, 0x26, 0x03, 0x93, 0x01, 0x11 },
    { 0xf4, 0x05, 0xfa, 0x02, 0x7d, 0x01, 0x11 },
    { 0x83, 0x07, 0xc1, 0x03, 0xe0, 0x01, 0x11 },
    { 0x13, 0x07, 0x89, 0x03, 0xc4, 0x01, 0x3d },
    { 0x63, 0x09, 0xb1, 0x04, 0x58, 0x02, 0x04 },
    { 0x9d, 0x0a, 0x4e, 0x05, 0xa7, 0x02, 0x04 },
    { 0x63, 0x09, 0xb1, 0x04, 0x58, 0x02, 0x57 },
    { 0xae, 0x0c, 0x57, 0x06, 0x2b, 0x03, 0x11 },
    { 0xe8, 0x0b, 0xf4, 0x05, 0xfa, 0x02, 0x11 },
    { 0x06, 0x0f, 0x83, 0x07, 0xc1, 0x03, 0x11 },
    { 0x27, 0x0e, 0x13, 0x07, 0x89, 0x03, 0x45 },
    { 0x06, 0x0f, 0x83, 0x07, 0xc1, 0x03, 0x08 },
    { 0xae, 0x0c, 0x57, 0x06, 0x2b, 0x03, 0x08 },
    { 0x9d, 0x0a, 0x4e, 0x05, 0xa7, 0x02, 0x08 },
    { 0xf5, 0x08, 0x7a, 0x04, 0x3d, 0x02, 0x08 },
    { 0x83, 0x07, 0xc1, 0x03, 0xe0, 0x01, 0x08 },
    { 0x4c, 0x06, 0x26, 0x03, 0x93, 0x01, 0x08 },
    { 0x47, 0x05, 0xa3, 0x02, 0x51, 0x01, 0x08 },
    { 0x70, 0x04, 0x38, 0x02, 0x1c, 0x01, 0x08 },
    { 0xbd, 0x03, 0xde, 0x01, 0xef, 0x00, 0x08 },
    { 0x23, 0x03, 0x91, 0x01, 0xc8, 0x00, 0x08 },
    { 0xa3, 0x02, 0x51, 0x01, 0xa8, 0x00, 0x08 },
    { 0x38, 0x02, 0x1c, 0x01, 0x8e, 0x00, 0x08 },
    { 0xde, 0x01, 0xef, 0x00, 0x77, 0x00, 0x22 },
    { 0x27, 0x0e, 0x13, 0x07, 0x89, 0x03, 0x22 },
    { 0xf5, 0x08, 0x7a, 0x04, 0x3d, 0x02, 0x22 },
    { 0x63, 0x09, 0xb1, 0x04, 0x58, 0x02, 0x11 },
    { 0x9d, 0x0a, 0x4e, 0x05, 0xa7, 0x02, 0x11 },
    { 0xe8, 0x0b, 0xf4, 0x05, 0xfa, 0x02, 0x11 },
    { 0x06, 0x0f, 0x83, 0x07, 0xc1, 0x03, 0x11 },
    { 0x27, 0x0e, 0x13, 0x07, 0x89, 0x03, 0x8b },
};
static const tune_t taccata = {
    taccata_notes,
    sizeof(taccata_notes) / sizeof(taccata_notes[0])
};

static const note_t phantom_notes[] = {
    { 0x13, 0x07, 0x89, 0x03, 0xc4, 0x01, 0x16 },
    { 0x83, 0x07, 0xc1, 0x03, 0xe0, 0x01, 0x16 },
    { 0x39, 0x0b, 0x9c, 0x05, 0xce, 0x02, 0x5a },
};
static const tune_t phantom = {
    phantom_notes,
    sizeof(phantom_notes) / sizeof(phantom_notes[0])
};

void tunes_stop(void)
{
    gd->tune_playing = 0;
    ym_write(YM_ENABLE, 0xff);
}

static void tunes_load(const note_t *np)
{
    ym_write(YM_AFINE, np->afine);
    ym_write(YM_ACOARSE, np->acoarse);
    ym_write(YM_BFINE, np->bfine);
    ym_write(YM_BCOARSE, np->bcoarse);
    ym_write(YM_CFINE, np->cfine);
    ym_write(YM_CCOARSE, np->ccoarse);
    gd->tune_cntdn = np->duration;
}

void tunes_start(uint8_t snd)
{
    const tune_t *tp;
    const note_t *np;

    if (snd == 0x20 || snd == 0x21) {
        tp = (snd == 0x20) ? &phantom : &taccata;
        np = tp->notes;
        tunes_load(np++);
        ym_write(YM_ENABLE, 0xf8);
        ym_write(YM_AVOL, 0x9);
        ym_write(YM_BVOL, 0xa);
        ym_write(YM_CVOL, 0xb);
        gd->tune_ptr = np;
        gd->tune_end = &tp->notes[tp->len];
        asm volatile("" ::: "memory");
        gd->tune_playing = 1;
        asm volatile("" ::: "memory");
    }
}

void tunes_timer(void)
{
    const note_t *np;

    if (gd->tune_playing) {
        if (--gd->tune_cntdn == 0) {
            np = gd->tune_ptr;
            if (np == gd->tune_end) {
                gd->tune_playing = 0;
                ym_write(YM_ENABLE, 0xff);
            } else {
                tunes_load(np++);
                gd->tune_ptr = np;
            }
        }
    }
}
